{% extends "base.html" %}

{% block title %}3D Warehouse - Grid View{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">3D Warehouse</h1>
                <p class="text-sm text-gray-600 mt-1">Filterable grid view with inline editing</p>
            </div>
            <div class="flex space-x-2">
                <button id="bulk-actions-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium hidden">
                    Bulk Actions
                </button>
                <button id="select-all-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Select All
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <!-- Search -->
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" name="search" id="search" value="{{ filters.search or '' }}"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                       placeholder="Search files...">
            </div>
            
            <!-- Brand -->
            <div>
                <label for="brand" class="block text-sm font-medium text-gray-700">Brand</label>
                <select name="brand" id="brand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">All Brands</option>
                    {% for brand in filter_options.brands %}
                    <option value="{{ brand }}" {% if filters.brand == brand %}selected{% endif %}>{{ brand | title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- File Type -->
            <div>
                <label for="file_type" class="block text-sm font-medium text-gray-700">File Type</label>
                <select name="file_type" id="file_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">All Types</option>
                    {% for file_type in filter_options.file_types %}
                    <option value="{{ file_type }}" {% if filters.file_type == file_type %}selected{% endif %}>{{ file_type | upper }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Furniture Type -->
            <div>
                <label for="furniture_type" class="block text-sm font-medium text-gray-700">Furniture Type</label>
                <select name="furniture_type" id="furniture_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">All Types</option>
                    {% for furniture_type in filter_options.furniture_types %}
                    <option value="{{ furniture_type }}" {% if filters.furniture_type == furniture_type %}selected{% endif %}>{{ furniture_type }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Status -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">All Status</option>
                    {% for status in filter_options.statuses %}
                    <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>{{ status | title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- URL Health -->
            <div>
                <label for="url_health" class="block text-sm font-medium text-gray-700">URL Health</label>
                <select name="url_health" id="url_health" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">All Health</option>
                    {% for health in filter_options.url_healths %}
                    <option value="{{ health }}" {% if filters.url_health == health %}selected{% endif %}>{{ health | title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Filter Button -->
            <div class="lg:col-span-6 flex justify-end">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Results Summary -->
    <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
                Showing {{ pagination.start_item }} to {{ pagination.end_item }} of {{ pagination.total }} files
            </div>
            <div class="text-sm text-gray-600">
                Page {{ pagination.page }} of {{ pagination.total_pages }}
            </div>
        </div>
    </div>

    <!-- Files Grid -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-3 py-3 text-left">
                        <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thumbnail</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Info</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Furniture Type</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtype</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variant</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL Health</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for file in files %}
                <tr class="hover:bg-gray-50 file-row" data-sha256="{{ file.sha256 }}">
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="checkbox" class="file-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="{{ file.sha256 }}">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        {% if file.thumbnail_url %}
                        <img src="{{ file.thumbnail_url }}" alt="{{ file.product_name }}" 
                             class="h-12 w-12 object-cover rounded-lg border border-gray-200"
                             onerror="this.style.display='none'">
                        {% else %}
                        <div class="h-12 w-12 bg-gray-200 rounded-lg flex items-center justify-center">
                            <span class="text-gray-400 text-xs">{{ file.file_type | upper }}</span>
                        </div>
                        {% endif %}
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-sm">
                            <div class="font-medium text-gray-900">{{ file.product_name }}</div>
                            <div class="text-gray-500">{{ file.brand | title }}</div>
                            <div class="text-xs text-gray-400">
                                {{ file.file_type | upper }} • {{ file.size_bytes | format_size }}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="editable-field" data-field="furniture_type" data-sha256="{{ file.sha256 }}">
                            <span class="field-value">{{ file.furniture_type or 'Not set' }}</span>
                            <input type="text" class="field-input hidden" value="{{ file.furniture_type or '' }}">
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="editable-field" data-field="subtype" data-sha256="{{ file.sha256 }}">
                            <span class="field-value">{{ file.subtype or 'Not set' }}</span>
                            <input type="text" class="field-input hidden" value="{{ file.subtype or '' }}">
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="editable-field" data-field="tags_csv" data-sha256="{{ file.sha256 }}">
                            <span class="field-value">{{ file.tags_csv or 'No tags' }}</span>
                            <input type="text" class="field-input hidden" value="{{ file.tags_csv or '' }}" placeholder="tag1,tag2,tag3">
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="editable-field" data-field="variant" data-sha256="{{ file.sha256 }}">
                            <span class="field-value">{{ file.variant }}</span>
                            <input type="text" class="field-input hidden" value="{{ file.variant }}">
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="editable-field" data-field="thumbnail_url" data-sha256="{{ file.sha256 }}">
                            <span class="field-value">
                                {% if file.thumbnail_url %}
                                <span class="text-green-600">✓ Has URL</span>
                                {% else %}
                                <span class="text-red-600">✗ No URL</span>
                                {% endif %}
                            </span>
                            <input type="url" class="field-input hidden" value="{{ file.thumbnail_url or '' }}" placeholder="https://...">
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                            {% if file.url_health == 'healthy' %}bg-green-100 text-green-800
                            {% elif file.url_health == 'broken' %}bg-red-100 text-red-800
                            {% elif file.url_health == 'timeout' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ file.url_health | title }}
                        </span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <a href="/file/{{ file.sha256 }}" class="text-blue-600 hover:text-blue-900">Download</a>
                            <button class="edit-btn text-green-600 hover:text-green-900">Edit</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="px-6 py-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex space-x-2">
                {% if pagination.page > 1 %}
                <a href="?page={{ pagination.page - 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                
                {% for page_num in range(1, pagination.total_pages + 1) %}
                {% if page_num == pagination.page %}
                <span class="px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-300 rounded-md">
                    {{ page_num }}
                </span>
                {% else %}
                <a href="?page={{ page_num }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    {{ page_num }}
                </a>
                {% endif %}
                {% endfor %}
                
                {% if pagination.page < pagination.total_pages %}
                <a href="?page={{ pagination.page + 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bulk Actions Modal -->
<div id="bulk-actions-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Bulk Actions</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Furniture Type</label>
                    <input type="text" id="bulk-furniture-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Subtype</label>
                    <input type="text" id="bulk-subtype" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tags (comma-separated)</label>
                    <input type="text" id="bulk-tags" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="bulk-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">No change</option>
                        <option value="active">Active</option>
                        <option value="archived">Archived</option>
                        <option value="processing">Processing</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-bulk" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                    Cancel
                </button>
                <button id="apply-bulk" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Apply to Selected
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Inline editing functionality
document.addEventListener('DOMContentLoaded', function() {
    // Edit button functionality
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const editableFields = row.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                const valueSpan = field.querySelector('.field-value');
                const input = field.querySelector('.field-input');
                valueSpan.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
            });
        });
    });

    // Save on Enter, cancel on Escape
    document.querySelectorAll('.field-input').forEach(input => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveField(this);
            } else if (e.key === 'Escape') {
                cancelEdit(this);
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => saveField(this), 100);
        });
    });

    function saveField(input) {
        const field = input.closest('.editable-field');
        const sha256 = field.dataset.sha256;
        const fieldName = field.dataset.field;
        const value = input.value.trim();
        
        fetch(`/api/files/${sha256}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                field: fieldName,
                value: value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const valueSpan = field.querySelector('.field-value');
                valueSpan.textContent = value || 'Not set';
                valueSpan.classList.remove('hidden');
                input.classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error saving field:', error);
            cancelEdit(input);
        });
    }

    function cancelEdit(input) {
        const field = input.closest('.editable-field');
        const valueSpan = field.querySelector('.field-value');
        valueSpan.classList.remove('hidden');
        input.classList.add('hidden');
    }

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    const bulkActionsBtn = document.getElementById('bulk-actions-btn');
    const selectAllBtn = document.getElementById('select-all-btn');

    selectAllCheckbox.addEventListener('change', function() {
        fileCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActionsVisibility();
    });

    fileCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionsVisibility);
    });

    function updateBulkActionsVisibility() {
        const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
        bulkActionsBtn.classList.toggle('hidden', selectedCount === 0);
        selectAllBtn.textContent = selectedCount === fileCheckboxes.length ? 'Deselect All' : 'Select All';
    }

    selectAllBtn.addEventListener('click', function() {
        const allChecked = Array.from(fileCheckboxes).every(cb => cb.checked);
        fileCheckboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        selectAllCheckbox.checked = !allChecked;
        updateBulkActionsVisibility();
    });

    // Bulk actions modal
    const modal = document.getElementById('bulk-actions-modal');
    const cancelBtn = document.getElementById('cancel-bulk');
    const applyBtn = document.getElementById('apply-bulk');

    bulkActionsBtn.addEventListener('click', function() {
        modal.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', function() {
        modal.classList.add('hidden');
    });

    applyBtn.addEventListener('click', function() {
        const selectedSha256s = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
        const updates = {};
        
        const furnitureType = document.getElementById('bulk-furniture-type').value.trim();
        const subtype = document.getElementById('bulk-subtype').value.trim();
        const tags = document.getElementById('bulk-tags').value.trim();
        const status = document.getElementById('bulk-status').value;
        
        if (furnitureType) updates.furniture_type = furnitureType;
        if (subtype) updates.subtype = subtype;
        if (tags) updates.tags_csv = tags;
        if (status) updates.status = status;
        
        if (Object.keys(updates).length === 0) {
            alert('Please fill in at least one field to update.');
            return;
        }
        
        fetch('/api/files/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sha256s: selectedSha256s,
                updates: updates
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Updated ${data.updated_count} files successfully!`);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error updating files:', error);
            alert('Error updating files. Please try again.');
        });
        
        modal.classList.add('hidden');
    });
});
</script>
{% endblock %}
